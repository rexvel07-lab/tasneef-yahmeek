// =====================================================
//  app.js โ ููุทู ุฃุฏุงุฉ ุงูุชุญูู + ุดุงุช ุงูุชุตููู ุงูุนูุฑู
//  ููุงุญุธุฉ: ูุฐุง ุณูุฑุจุช ุชุนููููุ ูุง ูุบูู ุนู ุงููุตุงุฏุฑ ุงูุฑุณููุฉ
// =====================================================

document.addEventListener("DOMContentLoaded", () => {
  // ุนูุงุตุฑ ุฃุฏุงุฉ ุงูุชุญูู
  const ratingForm = document.getElementById("rating-form");
  const queryInput = document.getElementById("query-input");
  const typeSelect = document.getElementById("content-type");
  const ratingResult = document.getElementById("rating-result");

  // ุนูุงุตุฑ ุงูุดุงุช
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const chatMessages = document.getElementById("chat-messages");

  // ูุงุนุฏุฉ ุจูุงูุงุช ุจุณูุทุฉ ูุฃูุซูุฉ ูุดููุฑุฉ (ุชุนููููุฉ)
  const ratingDB = {
    // ===== ุฃูุนุงุจ =====
    "fortnite": {
      name: "Fortnite",
      kind: "game",
      saAge: "12+ (ุชูุตูุฉ ุชูุฑูุจูุฉ)",
      globalAge: "PEGI 12 / ESRB Teen",
      reason: "ุนูู ูุชูุณุทุ ุฅุทูุงู ูุงุฑ ุจุฃุณููุจ ูุฑุชูููุ ููุงูุณุฉ ูุถุบุท ููุณู ูู ุจุนุถ ุงูุฃุทูุงุฑ.",
      noteForParents:
        "ูููุถูู ูุฑุงูุจุฉ ููุช ุงููุนุจุ ูุฅุทูุงุก ุงูุดุงุช ุงูุตูุชู ููุฃุทูุงูุ ูุงูุชุฃูุฏ ูู ุนุฏู ุงููุนุจ ูุณุงุนุงุช ุทูููุฉ."
    },
    "gta v": {
      name: "Grand Theft Auto V",
      kind: "game",
      saAge: "18+ (ุดุฏูุฏ ุงูุญุณุงุณูุฉ)",
      globalAge: "PEGI 18 / ESRB M",
      reason:
        "ุนูู ุดุฏูุฏุ ุฌุฑููุฉ ููุธูุฉุ ูุบุฉ ุจุฐูุฆุฉ ุฌุฏุงูุ ูุญุชูู ุบูุฑ ููุงุณุจ ููุงุฆูุงู ููุฃุทูุงู ูุงููุฑุงูููู.",
      noteForParents:
        "ูุง ูููุตุญ ุจุชูููู ูุฐู ุงููุนุจุฉ ููุฃุทูุงู ุฃู ุงููุฑุงูููู. ุชุญุชูู ุนูู ูุญุชูู ูุง ูุชูุงูู ูุน ููู ุงููุฌุชูุน."
    },
    "minecraft": {
      name: "Minecraft",
      kind: "game",
      saAge: "7+ ุชูุฑูุจุงู",
      globalAge: "PEGI 7 / ESRB 10+",
      reason:
        "ุนูู ุจุณูุท ุฌุฏุงู ูุน ูุงุฆูุงุช ูุฑุชูููุฉ (ุฒููุจูุ ููุงูู ุนุธููุฉ) ุถูู ุนุงูู ููุนุจุงุช.",
      noteForParents:
        "ุชุนุชุจุฑ ูู ุงูุฃูุนุงุจ ุงูุขููุฉ ูุณุจูุงูุ ูุน ุงูุงูุชุจุงู ููู online servers ูุงููุญุชูู ุงูุฐู ููุดุฆู ุงููุงุนุจูู."
    },
    "roblox": {
      name: "Roblox",
      kind: "game",
      saAge: "10โ12+ ูุน ุฑูุงุจุฉ",
      globalAge: "ESRB 10+ (ุนูู ุฃุบูุจ ุงูููุตุงุช)",
      reason:
        "ุงูููุตุฉ ุชุญุชูู ุนูู ุฃูุนุงุจ ูููุนุฉุ ุจุนุถ ุงูุฃูุนุงุจ ูุฏ ุชุญุชูู ุนูู ุฃู ูุญุชูู ุบูุฑ ููุงุณุจ.",
      noteForParents:
        "ูุนูู ุงูุฑูุงุจุฉ ุงูุฃุจููุฉุ ูุญุฏูุฏ ุงูุฃูุนุงุจ ุงููุณููุญุฉุ ูุฑุงุฌุน ูุงุฆูุฉ ุงูุฃุตุฏูุงุก ุจุงูุชุธุงู."
    },

    // ===== ุฃููุงู =====
    "frozen": {
      name: "Frozen",
      kind: "movie",
      saAge: "ูู ุงูุฃุนูุงุฑ (ูุน ุฅุดุฑุงู ุจุณูุท)",
      globalAge: "Rated PG",
      reason:
        "ูุดุงูุฏ ุชูุชุฑ ุฎูููุฉ ูุจุนุถ ุงูููุงูู ุงูุนุงุทููุฉุ ููููุง ููุงุณุจุฉ ุจุดูู ุนุงู ููุฃุทูุงู.",
      noteForParents:
        "ููุงุณุจ ููุนุธู ุงูุฃุนูุงุฑุ ูููู ุงุณุชุบูุงูู ููุญุฏูุซ ุนู ุงููุดุงุนุฑ ูุงูุนูุงูุงุช ุงูุฃุณุฑูุฉ."
    },
    "joker": {
      name: "Joker (2019)",
      kind: "movie",
      saAge: "18+",
      globalAge: "Rated R",
      reason:
        "ุนูู ููุณู ูุฌุณุฏูุ ููุงุถูุน ุตุญูุฉ ููุณูุฉ ูุนูุฏุฉุ ูุดุงูุฏ ูุงุณูุฉ ูุบูุฑ ููุงุณุจุฉ ูููุฑุงูููู ุงูุตุบุงุฑ.",
      noteForParents:
        "ูุง ูููุตุญ ุจู ูููุฑุงูููู ุฏูู 18 ุณูุฉุ ููุฏ ูุคุซุฑ ูู ูู ูุนุงูู ูู ุงุถุทุฑุงุจุงุช ููุณูุฉ."
    }
  };

  // ุฏุงูุฉ ูุณุงุนุฏุฉ: ุชูุธูู ุงููุต (lowercase + ุฅุฒุงูุฉ ุงููุฑุงุบุงุช)
  function normalize(text) {
    return text.toLowerCase().trim();
  }

  // ========= ุฃุฏุงุฉ ุงูุชุญูู =========
  if (ratingForm) {
    ratingForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const rawQuery = queryInput.value;
      const type = typeSelect.value;

      if (!rawQuery) return;

      const key = normalize(rawQuery);
      let result = null;

      // ูุญุงูู ูุทุงุจู ุจุงูุถุจุท ุฃู ุฌุฒุฆูุงู
      for (const k in ratingDB) {
        if (key.includes(k) || k.includes(key)) {
          // ูู ุงููุณุชุฎุฏู ุงุฎุชุงุฑ ููุน ูุนููู ูุชุญูู
          if (type === "auto" || type === ratingDB[k].kind) {
            result = ratingDB[k];
            break;
          }
        }
      }

      // ูุนุฑุถ ุงููุชูุฌุฉ
      ratingResult.classList.remove("hidden");

      if (result) {
        ratingResult.innerHTML = `
          <h3>ูุชูุฌุฉ ุงูุชุญูู ูู: <span>${result.name}</span></h3>
          <p><strong>ุงูุชุตููู ุงูุชูุฑูุจู ูู ุงูุณุนูุฏูุฉ:</strong> ${result.saAge}</p>
          <p><strong>ุงูุชุตููู ุงูุนุงููู (ุชูุฑูุจู):</strong> ${result.globalAge}</p>
          <p><strong>ุณุจุจ ุงูุชุตููู:</strong> ${result.reason}</p>
          <p><strong>ุชูุตูุงุช ูููุงูุฏูู:</strong> ${result.noteForParents}</p>
          <hr />
          <p style="font-size:13px;opacity:0.8">
            โ๏ธ ูุฐู ุงููุชูุฌุฉ ุชูุฑูุจูุฉ ุชุนููููุฉุ ูููุณุช ุญููุงู ุฑุณููุงู.<br/>
            ูููุฒูุฏ ููุตุญ ุจุฒูุงุฑุฉ: GCAM, PEGI, ESRB, CommonSenseMedia.
          </p>
        `;
      } else {
        ratingResult.innerHTML = `
          <h3>ูุง ูุฏุฑูุง ูููู ูุชูุฌุฉ ูุคูุฏุฉ ูู: <span>${rawQuery}</span></h3>
          <p>
            ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุชุนููููุฉ ูู ูุฐู ุงููุณุฎุฉ ูุง ุชุบุทู ูู ุงูุฃูุนุงุจ ูุงูุฃููุงู.
            ููุตุญู ุจุงูุจุญุซ ูู:
          </p>
          <ul>
            <li>ูููุน ุงูููุฆุฉ ุงูุนุงูุฉ ููุฅุนูุงู ุงููุฑุฆู ูุงููุณููุน (GCAM) ุฅู ูุฌุฏ.</li>
            <li>ููุงูุน <strong>ESRB</strong> ู <strong>PEGI</strong>.</li>
            <li>ูุณู "Parents Guide" ูู <strong>IMDb</strong>.</li>
          </ul>
          <p style="font-size:13px;opacity:0.8">
            ูุฐู ุงูููุตุฉ ููุชูุนูุฉ ููุทุ ูููุณุช ุจุฏููุงู ุนู ุงูุชุตููู ุงูุฑุณูู.
          </p>
        `;
      }
    });
  }

  // ========= ุงูุดุงุช: ุนุฑุถ ุฑุณุงูุฉ ูู ูุงุฌูุฉ ุงูุดุงุช =========
  function appendMessage(sender, text) {
    const div = document.createElement("div");
    div.classList.add("chat-message");
    div.classList.add(sender === "bot" ? "bot" : "user");
    div.innerHTML = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // ========= ููุทู ุฅุฌุงุจุฉ ุงูุดุงุช =========
  function buildAnswer(userText) {
    const t = normalize(userText);

    // 1) ูู ุณุฃู ุนู ูุนุจุฉ/ูููู ููุฌูุฏ ูู ุงููุงุนุฏุฉ
    for (const k in ratingDB) {
      if (t.includes(k)) {
        const r = ratingDB[k];
        return `
          <strong>${r.name}</strong><br/>
          ุงูุชุตููู ุงูุชูุฑูุจู ูู ุงูุณุนูุฏูุฉ: <strong>${r.saAge}</strong><br/>
          ุงูุชุตููู ุงูุนุงููู (ุชูุฑูุจู): <strong>${r.globalAge}</strong><br/>
          ุงูุณุจุจ: ${r.reason}<br/>
          <br/>
          ุชูุตูุฉ ูููุงูุฏูู: ${r.noteForParents}<br/><br/>
          ๐ ูููุฒูุฏ: ููุตุญู ุจุงูุงุทูุงุน ุนูู GCAM, PEGI, ESRB, CommonSenseMedia.
        `;
      }
    }

    // 2) ุฃุณุฆูุฉ ุนุงูุฉ ุนู ุงูุชุตููู
    if (t.includes("ููุด") && t.includes("ุงูุณุนูุฏู")) {
      return `
        ูู ุงูุบุงูุจ ุงูุชุตููู ุงูุณุนูุฏู ูููู ุฃุดุฏ ูู ุจุนุถ ุงูุชุตูููุงุช ุงูุฃุฌูุจูุฉ
        ูุฃูู ูุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ ููู ุงููุฌุชูุนุ ูุงูุฃูุธูุฉ ุงููุญููุฉุ ูุญุณุงุณูุฉ ุจุนุถ
        ุงูููุงุถูุน (ุงูุฏููุ ุงูุนูู ุงูุดุฏูุฏุ ุงูุฅูุญุงุกุงุช).<br/><br/>
        ูุฐูู ูุฏ ุชุฌุฏ ูุนุจุฉ ูุตููุฉ 12+ ูู ูุธุงู ุฃุฌูุจูุ ููููุง ุชูููุน ุฃู ุชูุตูู ุฃุนูู
        ูุญููุงู.
      `;
    }

    if (t.includes("ุขูู") || t.includes("ุขููุฉ") || t.includes("ูุทูู") || t.includes("ุงุจูู") || t.includes("ุจูุชู")) {
      return `
        ูุงุฎุชูุงุฑ ูุญุชูู ุขูู ูุทููููุ ุงุจุฏุฃ ุจุงูุชุงูู:<br/>
        โข ุงุฎุชุฑ ุงูุชุตููู ุงูููุงุณุจ ููุนูุฑ (3+, 7+, 12+ โฆ)<br/>
        โข ุฑุงูุจ ููุน ุงููุญุชูู (ุนููุ ุฑุนุจุ ูุบุฉ ุจุฐูุฆุฉุ ุชูููุญุงุชุ)<br/>
        โข ุญุฏูุฏ ููุช ุงููุนุจ ุฃู ุงููุดุงูุฏุฉุ ูุชุฃูุฏ ูู ูุฌูุฏู ุฃู ูุชุงุจุนุชู.<br/><br/>
        ููููู ุชุฌุฑุจุฉ ุฃุฏุงุฉ ุงูุชุญูู ุฃุนูู ุงูุตูุญุฉ ุจูุชุงุจุฉ ุงุณู ุงููุนุจุฉ ุฃู ุงููููู.
      `;
    }

    // 3) ูู ุณุฃู ุจุณ ุนู "ุฅูุด ูุนูู PEGI / ESRB"
    if (t.includes("pegi") || t.includes("esrb")) {
      return `
        PEGI ู ESRB ูู ุฃูุธูุฉ ุชุตููู ุนูุฑูุฉ ุนุงูููุฉ:<br/>
        โข <strong>PEGI</strong> ุชูุณุชุฎุฏู ุจูุซุฑุฉ ูู ุฃูุฑูุจุง.<br/>
        โข <strong>ESRB</strong> ุชูุณุชุฎุฏู ูู ุฃูุฑููุง ุงูุดูุงููุฉ.<br/><br/>
        ูู ูุธุงู ูุญุฏุฏ ุนูุฑ ููุงุณุจ + ุฃููููุงุช ุชูุถุญ ุณุจุจ ุงูุชุตููู (ุนููุ ุฑุนุจุ ูุบุฉโฆ).
        ููู ุฏุงุฆูุง
